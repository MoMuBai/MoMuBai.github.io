<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="搬砖的"><title>Activity 布局加载分析 | 沐白白白</title><link rel="stylesheet" type="text/css" href="//fonts.loli.net/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.3"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.3"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css?v=2.0.3"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js?v=2.0.3"></script><script src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=2.0.3"></script></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Activity 布局加载分析</h1><a id="logo" href="/.">沐白白白</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="https://github.com/MoMuBai/DailyQA"><i class="fa fa-dailyQA"> DailyQA</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="搜索"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Activity 布局加载分析</h1><div class="post-meta"><a href="/2019-11-2-Activity 布局加载分析/#comments" class="comment-count"></a><p><span class="date">Nov 02, 2019</span><span><a href="/categories/Android/" class="category">Android</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><p> <em>关于Activity需要知道的更多内容</em></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>关于Activity的创建以及执行回调onCreate方法我们已经知道了（看这里：<a href="https://www.jianshu.com/p/3de730c145be" target="_blank" rel="noopener">https://www.jianshu.com/p/3de730c145be</a><br>），然后我们今天想知道我们在onCreate中调用setContentView方法的时候，xml是如何加载的，所以今天就跟着源码来看看。<br>ps：源码版本为 android-26</p>
<p>一般来说我们写一个XxxActivity都会去继承Activity、FragmentActivity、AppCompatActivity这3个的其中一个，我们今天就分别对这几个父类Activity去分析</p>
<ul>
<li>1、Activity的xml加载过程</li>
<li>2、FragmentActivity的xml加载过程</li>
<li>3、AppCompatActivity的xml加载过程</li>
</ul>
<h3 id="一、Activity的xml加载过程"><a href="#一、Activity的xml加载过程" class="headerlink" title="一、Activity的xml加载过程"></a>一、Activity的xml加载过程</h3><p>进入我们setContentView方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## Activity</span><br><span class="line">public void setContentView(@LayoutRes int layoutResID) &#123;</span><br><span class="line">      getWindow().setContentView(layoutResID);//1、调用phoneWindow的setContentView方法</span><br><span class="line">      initWindowDecorActionBar();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这边注释的地方getWindow方法获取的一个window对象，它的实现类是PhoneWindow，它在Activity的attach中进行创建出来。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">## Activity</span><br><span class="line">final void attach(Context context, ...,</span><br><span class="line">           Window window, ActivityConfigCallback activityConfigCallback) &#123;</span><br><span class="line">       ...</span><br><span class="line">       mWindow = new PhoneWindow(this, window, activityConfigCallback);//这边进行window对象的初始化</span><br><span class="line">       ...</span><br><span class="line">       mWindow.setColorMode(info.colorMode);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>我们跟进PhoneWindow，看看它里面的setContentView方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">##PhoneWindow</span><br><span class="line">@Override</span><br><span class="line">public void setContentView(int layoutResID) &#123;</span><br><span class="line">    if (mContentParent == null) &#123;</span><br><span class="line">        installDecor();//1、加载DecorView</span><br><span class="line">    &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        final Scene newScene = Scene.getSceneForLayout(mContentParent, layoutResID,</span><br><span class="line">                getContext());</span><br><span class="line">        transitionTo(newScene);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mLayoutInflater.inflate(layoutResID, mContentParent);//2、布局加载器</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注释1是加载DecorView，注释2通过布局加载器将xml解析成view树，并且将view树添加到mContentParent中</p>
<h4 id="1、加载DecorView"><a href="#1、加载DecorView" class="headerlink" title="1、加载DecorView"></a>1、加载DecorView</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line">### PhoneWindow</span><br><span class="line">/**</span><br><span class="line"> * 加载DecorView</span><br><span class="line"> */</span><br><span class="line">private void installDecor() &#123;</span><br><span class="line">        mForceDecorInstall = false;</span><br><span class="line">        if (mDecor == null) &#123;</span><br><span class="line">            mDecor = generateDecor(-1);//1、创建DecorView</span><br><span class="line">            ...</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            mDecor.setWindow(this);//2、DecorView绑定到Window</span><br><span class="line">        &#125;</span><br><span class="line">        if (mContentParent == null) &#123;</span><br><span class="line">            mContentParent = generateLayout(mDecor);//3、根据DecorView生成Layout，得到一个mContentParent</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> * 1、创建DecorView</span><br><span class="line"> */</span><br><span class="line">protected DecorView generateDecor(int featureId) &#123;</span><br><span class="line">    ... //这边去创建DecorView</span><br><span class="line">    return new DecorView(context, featureId, this, getAttributes());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> *2、调用DecorView的setWindow，传入PhoneWindow对象</span><br><span class="line"> */</span><br><span class="line"> void setWindow(PhoneWindow phoneWindow) &#123;</span><br><span class="line">        mWindow = phoneWindow;</span><br><span class="line">        ...</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"> *3、根据DecorView生成Layout</span><br><span class="line"> */</span><br><span class="line">protected ViewGroup generateLayout(DecorView decor) &#123;</span><br><span class="line">    // Apply data from current theme.</span><br><span class="line">    //1、获取当前的主题，然后设置相关数据到window上</span><br><span class="line">    TypedArray a = getWindowStyle();</span><br><span class="line">    ...</span><br><span class="line">    mIsFloating = a.getBoolean(R.styleable.Window_windowIsFloating, false);//2、当前Window是否浮动在上面，默认为false</span><br><span class="line">    int flagsToUpdate = (FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR)</span><br><span class="line">            &amp; (~getForcedWindowFlags());</span><br><span class="line">    if (mIsFloating) &#123;</span><br><span class="line">        setLayout(WRAP_CONTENT, WRAP_CONTENT);//3、传入window的宽、高</span><br><span class="line">        setFlags(0, flagsToUpdate);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        setFlags(FLAG_LAYOUT_IN_SCREEN|FLAG_LAYOUT_INSET_DECOR, flagsToUpdate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (a.getBoolean(R.styleable.Window_windowNoTitle, false)) &#123;//4、window是否有title</span><br><span class="line">        requestFeature(FEATURE_NO_TITLE);//5、请求指定Window的风格，它必须在setContentView之前</span><br><span class="line">    &#125; else if (a.getBoolean(R.styleable.Window_windowActionBar, false)) &#123;</span><br><span class="line">        // Don&apos;t allow an action bar if there is no title.</span><br><span class="line">        requestFeature(FEATURE_ACTION_BAR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    //6、这边会很多的设置窗口属性的判断和方法，具体可以大家可以去看源码</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    // Inflate the window decor.</span><br><span class="line">    //7、根据上面设置的窗口的属性 ，设置相应的 layoutResource</span><br><span class="line">    int layoutResource;</span><br><span class="line">    int features = getLocalFeatures();</span><br><span class="line">    if ((features &amp; (1 &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != 0) &#123;</span><br><span class="line">        layoutResource = R.layout.screen_swipe_dismiss;</span><br><span class="line">        setCloseOnSwipeEnabled(true);</span><br><span class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_LEFT_ICON) | (1 &lt;&lt; FEATURE_RIGHT_ICON))) != 0) &#123;</span><br><span class="line">        if (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = new TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogTitleIconsDecorLayout, res, true);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            layoutResource = R.layout.screen_title_icons;</span><br><span class="line">        &#125;</span><br><span class="line">        removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">    &#125; else if ((features &amp; ((1 &lt;&lt; FEATURE_PROGRESS) | (1 &lt;&lt; FEATURE_INDETERMINATE_PROGRESS))) != 0</span><br><span class="line">            &amp;&amp; (features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) == 0) &#123;</span><br><span class="line">        layoutResource = R.layout.screen_progress;</span><br><span class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_CUSTOM_TITLE)) != 0) &#123;</span><br><span class="line">        if (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = new TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogCustomTitleDecorLayout, res, true);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            layoutResource = R.layout.screen_custom_title;</span><br><span class="line">        &#125;</span><br><span class="line">        removeFeature(FEATURE_ACTION_BAR);</span><br><span class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_NO_TITLE)) == 0) &#123;</span><br><span class="line">        if (mIsFloating) &#123;</span><br><span class="line">            TypedValue res = new TypedValue();</span><br><span class="line">            getContext().getTheme().resolveAttribute(</span><br><span class="line">                    R.attr.dialogTitleDecorLayout, res, true);</span><br><span class="line">            layoutResource = res.resourceId;</span><br><span class="line">        &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_BAR)) != 0) &#123;</span><br><span class="line">            layoutResource = a.getResourceId(</span><br><span class="line">                  R.styleable.Window_windowActionBarFullscreenDecorLayout,</span><br><span class="line">                    R.layout.screen_action_bar);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            layoutResource = R.layout.screen_title;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if ((features &amp; (1 &lt;&lt; FEATURE_ACTION_MODE_OVERLAY)) != 0) &#123;</span><br><span class="line">        layoutResource = R.layout.screen_simple_overlay_action_mode;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // Embedded, so no decoration is needed.</span><br><span class="line">        layoutResource = R.layout.screen_simple;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    mDecor.startChanging();//8、开始DecorView的变化</span><br><span class="line">    mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);//9、根据布局文件xml加载得到View树</span><br><span class="line"></span><br><span class="line">    ViewGroup contentParent = (ViewGroup)findViewById(ID_ANDROID_CONTENT);//10、根据content id返回一个contentParent，是一个viewGroup</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    mDecor.finishChanging(); //11、结束DecorView的变化</span><br><span class="line"></span><br><span class="line">    return contentParent; //12、返回一个contentParent</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面这段源码中，我们主要是做了几件事：</p>
<ul>
<li>1、注释1这里的样式通常是用来描述窗口的，通常view的样式是通过layout来描述的，而窗口的样式是通过Androidmanifest.xml来配置的，所以我们这里通过调用getWindowStyle方法，然后得到一个TypedArray对象，这个类我们比较熟悉，在我们自定义View的时候，如果需要自定义style，我们都会在初始化的时候得到一个TypedArray对象，然后去设置相关的样式。</li>
<li>2、注释2返回一个boolean值，表示我们的window是否悬浮在上面，然后根据这个值去设置相关的window宽高和其他的标签，注释4和注释6的地方判断window是否有title或者是否没有ActionBar，然后通过注释5的地方调用requestFeature去设置相关属性，所以我们这边会是否能联想到我们去如果在Activity的onCreat方法里去设置全屏的时候，需要在setConentView之前去设置，因为在setContentView之后的话，installDecor方法就已经执行完毕了，那我们设置的window属性就没有作用了。</li>
<li>3、注释7的地方根据上面设置的窗口的属性，来设置相关的layoutResource，我们可以去源码中查找相应的layout，具体位置在：frameworks/base/core/res/res/layout下<br><img src="https://upload-images.jianshu.io/upload_images/4248391-c7d5b09e0da27884.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/540" alt="image.png"></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">##screen_simple</span><br><span class="line">&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    android:fitsSystemWindows=&quot;true&quot;</span><br><span class="line">    android:orientation=&quot;vertical&quot;&gt;</span><br><span class="line">    &lt;ViewStub android:id=&quot;@+id/action_mode_bar_stub&quot;</span><br><span class="line">              android:inflatedId=&quot;@+id/action_mode_bar&quot;</span><br><span class="line">              android:layout=&quot;@layout/action_mode_bar&quot;</span><br><span class="line">              android:layout_width=&quot;match_parent&quot;</span><br><span class="line">              android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">              android:theme=&quot;?attr/actionBarTheme&quot; /&gt;</span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">         android:id=&quot;@android:id/content&quot;</span><br><span class="line">         android:layout_width=&quot;match_parent&quot;</span><br><span class="line">         android:layout_height=&quot;match_parent&quot;</span><br><span class="line">         android:foregroundInsidePadding=&quot;false&quot;</span><br><span class="line">         android:foregroundGravity=&quot;fill_horizontal|top&quot;</span><br><span class="line">         android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</span><br><span class="line">&lt;/LinearLayout&gt;</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/4248391-8f83b29234587d89.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/540" alt="image.png"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">##screen_simple_overlay_action_mode</span><br><span class="line">&lt;FrameLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">    android:layout_width=&quot;match_parent&quot;</span><br><span class="line">    android:layout_height=&quot;match_parent&quot;</span><br><span class="line">    android:fitsSystemWindows=&quot;true&quot;&gt;</span><br><span class="line">    &lt;FrameLayout</span><br><span class="line">         android:id=&quot;@android:id/content&quot;</span><br><span class="line">         android:layout_width=&quot;match_parent&quot;</span><br><span class="line">         android:layout_height=&quot;match_parent&quot;</span><br><span class="line">         android:foregroundInsidePadding=&quot;false&quot;</span><br><span class="line">         android:foregroundGravity=&quot;fill_horizontal|top&quot;</span><br><span class="line">         android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</span><br><span class="line">    &lt;ViewStub android:id=&quot;@+id/action_mode_bar_stub&quot;</span><br><span class="line">              android:inflatedId=&quot;@+id/action_mode_bar&quot;</span><br><span class="line">              android:layout=&quot;@layout/action_mode_bar&quot;</span><br><span class="line">              android:layout_width=&quot;match_parent&quot;</span><br><span class="line">              android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">              android:theme=&quot;?attr/actionBarTheme&quot; /&gt;</span><br><span class="line">&lt;/FrameLayout&gt;</span><br></pre></td></tr></table></figure></p>
<p>我们能够发现这几个layout里面都包含了一个id为content的FrameLayout，它是用来添加我们自己的布局。</p>
<ul>
<li>4、注释9根据我们上面得到的布局文件加载onResourcesLoaded得到view树<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">##DecorView</span><br><span class="line">void onResourcesLoaded(LayoutInflater inflater, int layoutResource) &#123;</span><br><span class="line">    ...</span><br><span class="line">   //创建一个DecorCaptionView，它是Decor的标题View, 它包含了标题和窗口控件按钮，它的可见性取决于工作空间和窗口类型</span><br><span class="line">    mDecorCaptionView = createDecorCaptionView(inflater);</span><br><span class="line">    final View root = inflater.inflate(layoutResource, null);//1、用LayoutInflate来加载xml布局文件得到view</span><br><span class="line">    //2、 若不 null 则先添加 mDecorCaptionView, 再向 mDecorCaptionView 中添加 root</span><br><span class="line">    if (mDecorCaptionView != null) &#123;</span><br><span class="line">        if (mDecorCaptionView.getParent() == null) &#123;</span><br><span class="line">            //将 mDecorCaptionView 添加到DecorView</span><br><span class="line">            addView(mDecorCaptionView,</span><br><span class="line">                    new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">        &#125;</span><br><span class="line">        //获取的到root add到 mDecorCaptionView 中</span><br><span class="line">        mDecorCaptionView.addView(root,</span><br><span class="line">                new ViewGroup.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        // 3、若mDecorCaptionView为 null, 则直接添加调用addView将 root 加到 DecorView 中</span><br><span class="line">        // Put it below the color views.</span><br><span class="line">        addView(root, 0, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">    &#125;</span><br><span class="line">    // 4、强转成 ViewGroup, 传递给 mContentRoot</span><br><span class="line">    mContentRoot = (ViewGroup) root;</span><br><span class="line">    initializeElevation();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">private DecorCaptionView createDecorCaptionView(LayoutInflater inflater) &#123;</span><br><span class="line">    ...</span><br><span class="line">   //这里将源码稍微变动下，直接调用inflateDecorCaptionView方法</span><br><span class="line">    DecorCaptionView decorCaptionView =  inflateDecorCaptionView(inflater)</span><br><span class="line">    ...</span><br><span class="line">    return decorCaptionView;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private DecorCaptionView inflateDecorCaptionView(LayoutInflater inflater) &#123;</span><br><span class="line">    final Context context = getContext();</span><br><span class="line">    inflater = inflater.from(context);</span><br><span class="line">    //这边通过LayoutInflater来获到DecorCaptionView</span><br><span class="line">    final DecorCaptionView view = (DecorCaptionView) inflater.inflate(R.layout.decor_caption,</span><br><span class="line">            null);</span><br><span class="line">    setDecorCaptionShade(context, view);</span><br><span class="line">    return view;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>可以看到在onResourcesLoaded这里是我们做了4件事：</p>
<ul>
<li>4.1、注释1是根据LayoutInflate加载xml布局文件得到View对象 root</li>
<li>4.2、注释2判断DecorCaptionView是否为null，不为null，先去添加DecorCaptionView，再去添加root（DecorCaptionView是一个标题view，这个类表示用于控制自由格式上窗口的特殊屏幕元素）</li>
<li>4.3、注释3如果DecorCaptionView为null，就直接将root添加到DecorView中</li>
<li>4.4、注释4是将root强转成一个ViewGroup并传递给mContentRoot</li>
</ul>
<ul>
<li>5、在注释10这里根据我们的ID_ANDROID_CONTENT通过findViewById返回一个contentParent，它是我们在步骤3中的DecorView中mContentRoot中的FrameLayout的Id，也就是我们通过setContentView将布局添加进去的地方。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">##Window</span><br><span class="line"> public static final int ID_ANDROID_CONTENT = com.android.internal.R.id.content</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="2、布局加载器加载xml生成View树"><a href="#2、布局加载器加载xml生成View树" class="headerlink" title="2、布局加载器加载xml生成View树"></a>2、布局加载器加载xml生成View树</h4><p>通过LayoutInflater布局加载器去生成View树<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">##LayoutInflater</span><br><span class="line">public View inflate(@LayoutRes int resource, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">    final Resources res = getContext().getResources();</span><br><span class="line">    ...</span><br><span class="line">    final XmlResourceParser parser = res.getLayout(resource);//1、根据xml id 得到一个xml解析器资源</span><br><span class="line">    try &#123;</span><br><span class="line">        return inflate(parser, root, attachToRoot);//2、传入xml解析器资源和mContentParent</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        parser.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<ul>
<li>1、注释1得到一个xml解析器资源</li>
<li>2、注释3 调用inflate返回view<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">##LayoutInflater</span><br><span class="line">public View inflate(XmlPullParser parser, @Nullable ViewGroup root, boolean attachToRoot) &#123;</span><br><span class="line">    synchronized (mConstructorArgs) &#123;</span><br><span class="line">        ...</span><br><span class="line">        View result = root;//1、它就是我们最终返回的view对象</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            // Look for the root node.</span><br><span class="line">            int type;</span><br><span class="line"></span><br><span class="line">            ...</span><br><span class="line">          	</span><br><span class="line">            final String name = parser.getName();//XmlPullParser解析xml，获取里面的标签name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            if (TAG_MERGE.equals(name)) &#123;//这里获取的name如果是merge，则root不能为null，否则会抛出异常</span><br><span class="line">                if (root == null || !attachToRoot) &#123;</span><br><span class="line">                    throw new InflateException(&quot;&lt;merge /&gt; can be used only with a valid &quot;</span><br><span class="line">                            + &quot;ViewGroup root and attachToRoot=true&quot;);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                rInflate(parser, root, inflaterContext, attrs, false);</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // Temp is the root view that was found in the xml</span><br><span class="line">                //2、这边创建得到一个临时的view对象 temp</span><br><span class="line">                final View temp = createViewFromTag(root, name, inflaterContext, attrs);</span><br><span class="line"></span><br><span class="line">                ViewGroup.LayoutParams params = null;</span><br><span class="line"></span><br><span class="line">                ...</span><br><span class="line">                if (root != null &amp;&amp; attachToRoot) &#123;//3、这边判断如果root不为null，则将临时的view对象temp添加到root中</span><br><span class="line">                    root.addView(temp, params);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                if (root == null || !attachToRoot) &#123;//4、如果root为null，将temp传递给我们的最终view</span><br><span class="line">                    result = temp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        return result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>这里通过一系列的判断和传递最终会得到一个View对象，它就是我们根据xml去解析加载出来的View树。</p>
<p>附加一张window和contentView的层次结构图</p>
<p><img src="https://upload-images.jianshu.io/upload_images/4147272-00b5f60232885fac.jpg" alt="image.png"></p>
<h3 id="二、AppCompatActivity的xml加载"><a href="#二、AppCompatActivity的xml加载" class="headerlink" title="二、AppCompatActivity的xml加载"></a>二、AppCompatActivity的xml加载</h3><p>跟进AppCompatActivity的setContentView方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">##AppCompatActivity</span><br><span class="line">@Override</span><br><span class="line">public void setContentView(@LayoutRes int layoutResID) &#123;</span><br><span class="line">    getDelegate().setContentView(layoutResID);//调用getDelegate的setContentView</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这边的getDelegate返回的是一个AppCompatDelegate，它是一个抽象类，这边我们跟踪发现最后是在AppCompatDelegateImplV9中调用了setContentView方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">##AppCompatDelegateImplV9</span><br><span class="line">@Override</span><br><span class="line">public void setContentView(int resId) &#123;</span><br><span class="line">    ensureSubDecor();//1、创建DecorView</span><br><span class="line">    ViewGroup contentParent = (ViewGroup) mSubDecor.findViewById(android.R.id.content);//2、这边根据content id去返回一个contentParent</span><br><span class="line">    contentParent.removeAllViews();</span><br><span class="line">    LayoutInflater.from(mContext).inflate(resId, contentParent);//3、通过LayoutInflater布局加载器将xml解析得到View树，添加到contentParent中</span><br><span class="line">    mOriginalWindowCallback.onContentChanged();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="1、注释1创建DecorView"><a href="#1、注释1创建DecorView" class="headerlink" title="1、注释1创建DecorView"></a>1、注释1创建DecorView</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">##AppCompatDelegateImplV9</span><br><span class="line">private void ensureSubDecor() &#123;</span><br><span class="line">    if (!mSubDecorInstalled) &#123;</span><br><span class="line">        mSubDecor = createSubDecor();//调用createSubDecor方法</span><br><span class="line">      	...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private ViewGroup createSubDecor() &#123;</span><br><span class="line">    TypedArray a = mContext.obtainStyledAttributes(R.styleable.AppCompatTheme);</span><br><span class="line"></span><br><span class="line">	//获取当前的主题，然后设置相关数据到window上</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    mWindow.getDecorView();//1、调用PhoneWindow的getDecorView方法</span><br><span class="line"></span><br><span class="line">    final LayoutInflater inflater = LayoutInflater.from(mContext);</span><br><span class="line">    ViewGroup subDecor = null;//定义一个viewgroup</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //2、根据window的样式不同去加载不同的layout</span><br><span class="line">    if (!mWindowNoTitle) &#123;</span><br><span class="line">        if (mIsFloating) &#123;</span><br><span class="line">           	...</span><br><span class="line">            subDecor = (ViewGroup) inflater.inflate(</span><br><span class="line">                    R.layout.abc_dialog_title_material, null);</span><br><span class="line">            ...</span><br><span class="line">        &#125; else if (mHasActionBar) &#123;</span><br><span class="line">           	...</span><br><span class="line">            subDecor = (ViewGroup) LayoutInflater.from(themedContext)</span><br><span class="line">                    .inflate(R.layout.abc_screen_toolbar, null);</span><br><span class="line">          	...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        if (mOverlayActionMode) &#123;</span><br><span class="line">            subDecor = (ViewGroup) inflater.inflate(</span><br><span class="line">                    R.layout.abc_screen_simple_overlay_action_mode, null);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            subDecor = (ViewGroup) inflater.inflate(R.layout.abc_screen_simple, null);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       	...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">   	...</span><br><span class="line"></span><br><span class="line">   	//3、下面具体分析</span><br><span class="line">    // Make the decor optionally fit system windows, like the window&apos;s decor</span><br><span class="line">    ViewUtils.makeOptionalFitsSystemWindows(subDecor);</span><br><span class="line"></span><br><span class="line">    final ContentFrameLayout contentView = (ContentFrameLayout) subDecor.findViewById(</span><br><span class="line">            R.id.action_bar_activity_content);</span><br><span class="line"></span><br><span class="line">    final ViewGroup windowContentView = (ViewGroup) mWindow.findViewById(android.R.id.content);</span><br><span class="line">    if (windowContentView != null) &#123;</span><br><span class="line">        while (windowContentView.getChildCount() &gt; 0) &#123;</span><br><span class="line">            final View child = windowContentView.getChildAt(0);</span><br><span class="line">            windowContentView.removeViewAt(0);</span><br><span class="line">            contentView.addView(child);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // Change our content FrameLayout to use the android.R.id.content id.</span><br><span class="line">        // Useful for fragments.</span><br><span class="line">        windowContentView.setId(View.NO_ID);</span><br><span class="line">        contentView.setId(android.R.id.content);</span><br><span class="line"></span><br><span class="line">        // The decorContent may have a foreground drawable set (windowContentOverlay).</span><br><span class="line">        // Remove this as we handle it ourselves</span><br><span class="line">        if (windowContentView instanceof FrameLayout) &#123;</span><br><span class="line">            ((FrameLayout) windowContentView).setForeground(null);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //4、调用PhoneWindow的setContentView方法</span><br><span class="line">    // Now set the Window&apos;s content view with the decor</span><br><span class="line">    mWindow.setContentView(subDecor);</span><br><span class="line">    ...</span><br><span class="line">    return subDecor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在ensureSubDecor调用了createSubDecor方法：</p>
<ul>
<li><p>1、注释1调用了PhoneWindow的getDecorView方法，我们可以看到这里去调用了installDecor方法，这个方法我们在本篇的Activity的xml加载过程已经分析过了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">##PhoneWindow</span><br><span class="line">@Override</span><br><span class="line">public final View getDecorView() &#123;</span><br><span class="line">    if (mDecor == null || mForceDecorInstall) &#123;</span><br><span class="line">        installDecor();</span><br><span class="line">    &#125;</span><br><span class="line">    return mDecor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>2、注释2根据不同的window主题样式去加载不同的layout，然后通过布局加载器将xml解析成subDecor，每一个layout中都会include一个名为abc_screen_content_include.xml的layout，这个layout包含id为action_bar_activity_content的ContentFrameLayout。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">源码位置：/frameworks/support/v7/appcompat/res/layout/abc_dialog_title_material.xml</span><br><span class="line"></span><br><span class="line">##abc_screen_simple_overlay_action_mode</span><br><span class="line">&lt;android.support.v7.widget.FitWindowsFrameLayout</span><br><span class="line">        xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;</span><br><span class="line">        android:id=&quot;@+id/action_bar_root&quot;</span><br><span class="line">        android:layout_width=&quot;match_parent&quot;</span><br><span class="line">        android:layout_height=&quot;match_parent&quot;</span><br><span class="line">        android:fitsSystemWindows=&quot;true&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;include layout=&quot;@layout/abc_screen_content_include&quot; /&gt;</span><br><span class="line"></span><br><span class="line">    &lt;android.support.v7.widget.ViewStubCompat</span><br><span class="line">            android:id=&quot;@+id/action_mode_bar_stub&quot;</span><br><span class="line">            android:inflatedId=&quot;@+id/action_mode_bar&quot;</span><br><span class="line">            android:layout=&quot;@layout/abc_action_mode_bar&quot;</span><br><span class="line">            android:layout_width=&quot;match_parent&quot;</span><br><span class="line">            android:layout_height=&quot;wrap_content&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/android.support.v7.widget.FitWindowsFrameLayout&gt;</span><br><span class="line"></span><br><span class="line">##abc_screen_content_include</span><br><span class="line">&lt;merge xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;android.support.v7.widget.ContentFrameLayout</span><br><span class="line">            android:id=&quot;@id/action_bar_activity_content&quot;</span><br><span class="line">            android:layout_width=&quot;match_parent&quot;</span><br><span class="line">            android:layout_height=&quot;match_parent&quot;</span><br><span class="line">            android:foregroundGravity=&quot;fill_horizontal|top&quot;</span><br><span class="line">            android:foreground=&quot;?android:attr/windowContentOverlay&quot; /&gt;</span><br><span class="line"></span><br><span class="line">&lt;/merge&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>3、在注释3调用调用findViewById找到id为action_bar_activity_content的contentView，然后在通过PhoneWindow找到id为content的windowContentView，然后去循环遍历windowContentView，将它的的子View添加到contentView中去，然后在把windowContentView的id设置为-1，contentView的id设置为原来windowContentView的id content，这个地方可以简单的理解为就是将DecorView(windowContentView)中的view转移到subDecor(contentView)中。</p>
</li>
<li><p>4、注释4调用PhoneWindow的setContentView方法，将subDecor传递进去，然后将subDecor存放到mContentParent中，这边我们可以发现它和上一部分(Activity)的区别，在Activity中mContentParent是直接用来存放我们自定义xml布局的，在AppCompatActivity中，mContentParent会先存放一个subDecor，然后在subDecor才是真正存放我们的自定义xml布局。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">##PhoneWindow</span><br><span class="line">@Override</span><br><span class="line">public void setContentView(View view) &#123;</span><br><span class="line">    setContentView(view, new ViewGroup.LayoutParams(MATCH_PARENT, MATCH_PARENT));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@Override</span><br><span class="line">public void setContentView(View view, ViewGroup.LayoutParams params) &#123;</span><br><span class="line">    if (mContentParent == null) &#123;</span><br><span class="line">        installDecor();</span><br><span class="line">    &#125; else if (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        mContentParent.removeAllViews();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;</span><br><span class="line">        view.setLayoutParams(params);</span><br><span class="line">        final Scene newScene = new Scene(mContentParent, view);</span><br><span class="line">        transitionTo(newScene);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        mContentParent.addView(view, params);</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParent.requestApplyInsets();</span><br><span class="line">    final Callback cb = getCallback();</span><br><span class="line">    if (cb != null &amp;&amp; !isDestroyed()) &#123;</span><br><span class="line">        cb.onContentChanged();</span><br><span class="line">    &#125;</span><br><span class="line">    mContentParentExplicitlySet = true;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>一张层次结构图带你理解：</p>
<p><img src="https://upload-images.jianshu.io/upload_images/19552390-f9a55e06bc240d60.png" alt="image.png"></p>
<h3 id="三、FragmentActivity的xml加载"><a href="#三、FragmentActivity的xml加载" class="headerlink" title="三、FragmentActivity的xml加载"></a>三、FragmentActivity的xml加载</h3><p>关于FragmentActivity，我们可以发现它自己是没有实现setContentView的，它是直接调用了父类Activity的setContentView方法，所以我们可以看上面的Activity的xml加载过程就可以了。<br>但是为什么会有FragmentActivity以及它的作用呢，这就要从Fragment说起来，在Android3.0以前是没有Fragment的，为了能让3.0以前能使用Fragment我们需要引入了support包，然后去继承FragmentActivity就可以使用Fragment，在3.0以后我们可以选择直接继承Activity，就可以正常使用Fragment了。而且3.0以前获取FragmentManager的方法是getSupportFragmentManager，3.0以后直接用getFragmentManager就可以了。<br>关于Fragment和FragmentManager我们会在另外的文字里进行分析，这里就不多讲。</p>
<p>ps：关于FragmentActivity的api原文</p>
<p>FragmentActivity is a special activity provided in the Support Library to handle fragments on system versions older than API level 11. If the lowest system version you support is API level 11 or higher, then you can use a regular Activity.</p>
<h4 id="沿着别人走过的路，跟上去发现不一样的风景"><a href="#沿着别人走过的路，跟上去发现不一样的风景" class="headerlink" title="沿着别人走过的路，跟上去发现不一样的风景"></a>沿着别人走过的路，跟上去发现不一样的风景</h4><p>参考链接：</p>
<ul>
<li>1、<a href="https://www.jianshu.com/p/3872219cc07a" target="_blank" rel="noopener">https://www.jianshu.com/p/3872219cc07a</a></li>
<li>2、<a href="https://www.jianshu.com/p/fc717b47b322" target="_blank" rel="noopener">https://www.jianshu.com/p/fc717b47b322</a></li>
</ul>
</div><div class="post-copyright"><blockquote><p>原文作者: 沐白</p><p>原文链接: <a href="https:mubai.site/2019-11-2-Activity 布局加载分析/">https:mubai.site/2019-11-2-Activity 布局加载分析/</a></p><p>版权声明: 转载请注明出处(必须保留作者署名及链接)</p></blockquote></div><div class="tags"><a href="/tags/Android/">Android</a></div><div class="post-share"><div class="social-share"><span>分享到:</span></div></div><div class="post-nav"><a href="/2019-12-2-Rxjava2 太多方法了，记不住呀/" class="pre">Rxjava2 太多方法了，记不住呀</a><a href="/2019-10-28-Application的创建、Activity的创建/" class="next">Application的创建、Activity的创建</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#前言"><span class="toc-number">1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#一、Activity的xml加载过程"><span class="toc-number">2.</span> <span class="toc-text">一、Activity的xml加载过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、加载DecorView"><span class="toc-number">2.1.</span> <span class="toc-text">1、加载DecorView</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2、布局加载器加载xml生成View树"><span class="toc-number">2.2.</span> <span class="toc-text">2、布局加载器加载xml生成View树</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#二、AppCompatActivity的xml加载"><span class="toc-number">3.</span> <span class="toc-text">二、AppCompatActivity的xml加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1、注释1创建DecorView"><span class="toc-number">3.1.</span> <span class="toc-text">1、注释1创建DecorView</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#三、FragmentActivity的xml加载"><span class="toc-number">4.</span> <span class="toc-text">三、FragmentActivity的xml加载</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#沿着别人走过的路，跟上去发现不一样的风景"><span class="toc-number">4.1.</span> <span class="toc-text">沿着别人走过的路，跟上去发现不一样的风景</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020-3-21-礼物专线/">GiftForGirl</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-12-20-沉浸式状态栏/">沉浸式状态栏</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-12-2-Rxjava2 太多方法了，记不住呀/">Rxjava2 太多方法了，记不住呀</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-11-2-Activity 布局加载分析/">Activity 布局加载分析</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-10-28-Application的创建、Activity的创建/">Application的创建、Activity的创建</a></li><li class="post-list-item"><a class="post-list-link" href="/2019-3-31-5.1旅游攻略/">5.1节日旅游攻略</a></li><li class="post-list-item"><a class="post-list-link" href="/Me/">Me</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-10-9-物联网通信-WiFi:BT:ZigBee芯片级方案解析/">物联网设备-WiFi/Bluetooth/ZigBee配网方式</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-7-12-Nexus+Maven搭建私有库/">Nexus+Maven搭建私有库</a></li><li class="post-list-item"><a class="post-list-link" href="/2018-2-26-Android Gradle 中遇到的问题/">Android Gradle</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a><span class="category-list-count">21</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/开发规范/">开发规范</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/总结/">总结</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/机器学习/">机器学习</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/架构/">架构</a><span class="category-list-count">5</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/物联网/">物联网</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/算法/">算法</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/设计模式/">设计模式</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/闲文/">闲文</a><span class="category-list-count">5</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/开发规范/" style="font-size: 15px;">开发规范</a> <a href="/tags/算法/" style="font-size: 15px;">算法</a> <a href="/tags/架构/" style="font-size: 15px;">架构</a> <a href="/tags/闲文/" style="font-size: 15px;">闲文</a> <a href="/tags/总结/" style="font-size: 15px;">总结</a> <a href="/tags/设计模式/" style="font-size: 15px;">设计模式</a> <a href="/tags/物联网/" style="font-size: 15px;">物联网</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/Maven/" style="font-size: 15px;">Maven</a> <a href="/tags/简历/" style="font-size: 15px;">简历</a> <a href="/tags/礼物专线/" style="font-size: 15px;">礼物专线</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/03/">三月 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/12/">十二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/11/">十一月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">十月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">三月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">二月 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">二月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-you"> 友情链接</i></div><ul></ul><a href="https://juejin.im/" title="掘金" target="_blank">掘金</a><ul></ul><a href="https://www.wanandroid.com/" title="玩安卓" target="_blank">玩安卓</a><ul></ul><a href="https://www.simon96.online/2018/10/12/hexo-tutorial/" title="遇见西门" target="_blank">遇见西门</a></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">网站地图</a> |  <a href="/atom.xml">订阅本站</a> |  <a href="/about/">联系博主</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次，本站总访客数:<i id="busuanzi_container_site_uv"><i id="busuanzi_value_site_uv"></i></i>人</p><p><span> Copyright &copy;<a href="/." rel="nofollow">沐白.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.3"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.3" async></script><link rel="stylesheet" type="text/css" href="/share/css/share.css"><script type="text/javascript" src="/share/js/social-share.js" charset="utf-8"></script><script type="text/javascript" src="/share/js/qrcode.js" charset="utf-8"></script><script src="/live2dw/lib/L2Dwidget.min.js?bd2294fafea3389ee458f1d9be5a2157"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body></html>